# Agent Task: Integrate Auto Image Generation into RPG Companion

**Objective:** Implement an automatic image generation feature within the `rpg-companion-sillytavern` SillyTavern extension. This feature will leverage the extension's "Separate Mode" API call to generate image prompts based on tracked data and user configuration, then trigger SillyTavern's built-in image generation (`/sd` command).

**Context:** The RPG Companion extension tracks character stats, scene info (Info Box), and character thoughts. In "Separate Mode," it makes a second API call after the main chat reply to update these trackers. We will enhance this second call to also generate an image prompt and trigger the image generation.

**Core Requirements:**

1.  **Conditional Settings UI:**
    * New settings for Auto Image Generation should only appear in the RPG Companion settings modal (`#rpg-settings-popup`) when **both** "Generation Mode" is set to `separate` **and** "Use model connected to RPG Companion Trackers preset" is checked.
    * Add a main toggle: "Enable Auto Image Generation".
    * When enabled, reveal the following controls:
        * **Main Prompt Instructions:** A textarea pre-filled with the refined prompt structure (see "Refined Image Generation Prompt" below). It should be read-only by default, with an "Edit" button to unlock it.
        * **Custom Physical Description:** A textarea for the user to input character appearance details (used in Rule 1 of the prompt).
        * **Custom User Rules:** A textarea for custom rules (e.g., perspective, LoRAs - see `Example.md` context).
        * **Image Insertion:** A dropdown (`<select>`) with options: "Insert Inline (Last Message)" and "Create New Message".
        * **Prompt Tag Regex:** A textarea pre-filled with the default regex: `/<\s*pic\s+prompt\s*=\s*["']([^"']*)["']\s*>/g` (used to extract the generated prompt from the LLM response).

2.  **Functionality (Separate Mode Only):**
    * **Prompt Modification:** When Auto Image Generation is enabled, the prompt sent during the `updateRPGData` call (in `apiClient.js`) must be modified. Append the "Main Prompt Instructions" (including user's custom description and rules, if provided) to the existing tracker update instructions generated by `promptBuilder.js`.
    * **Response Parsing:** After receiving the response from the second API call:
        * Parse the tracker data as currently done in `apiClient.js` / `parser.js`.
        * Use the user-defined "Prompt Tag Regex" to find and extract the image prompt string from the *same* response text (specifically looking for the `<pic prompt="...">` tag).
    * **Image Generation Trigger:** If a valid image prompt string is extracted:
        * Execute SillyTavern's `/sd` slash command using the extracted prompt.
    * **Image Insertion:** Based on the "Image Insertion" setting:
        * **Inline:** Insert the generated image URL into the *last assistant message* in the chat history.
        * **New Message:** Create a new message in the chat containing only the generated image.

**Implementation Details & Rules:**

1.  **Verbatim Code:** Preserve existing `rpg-companion-sillytavern` code unless modifications are strictly necessary for this feature. Document all changes.
2.  **Preserve Functionality:** Ensure existing tracker functionality remains intact. Image generation is an addition.
3.  **Documentation:** Log all code alterations in a `changes.md` file with explanations.
4.  **Due Diligence:** Before finalizing, re-read this document, your `changes.md`, and the modified code. Ensure all requirements are met. Log findings in `due_diligence.md`.

**Key Files to Modify:**

* `src/core/state.js`: Add new state variables for the image generation settings (toggle state, prompts, regex, insertion type).
* `src/core/persistence.js`: Ensure new settings are loaded and saved correctly within `extensionSettings`.
* `template.html`: Add the new HTML elements for the settings UI within `#rpg-settings-popup`, ensuring conditional visibility.
* `index.js`:
    * Add event listeners for the new settings UI elements.
    * Implement logic to show/hide the image generation settings based on `generationMode` and `useSeparatePreset` changes.
    * Handle the "Edit" button logic for the main prompt textarea.
* `src/systems/generation/promptBuilder.js`: Modify `generateSeparateUpdatePrompt` (or relevant function constructing the prompt for the second API call). It should conditionally append the image generation instructions (including custom physical description and rules from settings) when the feature is enabled. Use SillyTavern macros like `{{user}}`, `{{char}}`, `{{persona}}` where appropriate in the prompt instructions if needed (though the refined prompt aims to avoid direct reliance if possible).
* `src/systems/generation/apiClient.js`: Modify the `updateRPGData` function:
    * Check `extensionSettings` if auto image generation is enabled.
    * If yes, ensure the correct prompt is fetched/built (using the modified `promptBuilder`).
    * After `generateRaw` returns, parse the response:
        * Extract tracker data (as currently done).
        * Use the regex from settings (`extensionSettings.imageGenRegex`) to find the `<pic prompt="...">` tag and extract the prompt string.
        * If a prompt is found:
            * Call `executeSlashCommandsOnChatInput` with `/sd ${extractedPrompt}` and appropriate options (likely `{ quiet: true }` if inserting inline, potentially `{ quiet: false }` if creating a new message, though `/sd` might handle this automatically - check behavior).
            * Handle the result (expected to be an image URL or similar identifier).
            * Based on `extensionSettings.imageInsertionType`:
                * If 'inline': Use `appendMediaToMessage(message, messageElement)` (requires getting the last assistant message object and its corresponding DOM element). You might need to adapt logic from `st-image-auto-generation/index.js` `handleIncomingMessage` function.
                * If 'new': You might need to use a function like `addMessage` or `sendSystemMessage` (investigate `script.js` or context functions) to create a new message entry containing just the image. The `/sd` command itself might create the message if `quiet: false` is used; verify this behavior.

**Essential SillyTavern Concepts & Functions (Explain these in implementation):**

* **`extensionSettings` (in `src/core/state.js`):** The primary object storing user configuration for the extension. Persisted via `power_user.extensions[extensionName]`.
* **`power_user` (imported from `power-user.js`):** Global object where extension settings are stored.
* **`saveSettingsDebounced` (imported from `script.js`):** Function to save `power_user` settings persistently.
* **`getContext` (imported from `extensions.js`):** Returns the main SillyTavern application context, providing access to chat history (`context.chat`), current character info, etc.
* **`generateRaw` (imported from `script.js`):** Function to make direct API calls to the LLM, bypassing some standard chat processing. Used in `apiClient.js`. Takes an object like `{ prompt: string | Array<object>, quietToLoud?: boolean }`. The prompt can be a simple string or an array of message objects (`{ role: 'user' | 'assistant' | 'system', content: string }`).
* **`executeSlashCommandsOnChatInput` (imported from `script.js`):** Function to programmatically execute SillyTavern slash commands. Crucial for triggering `/sd`. Takes the command string (e.g., `/sd your prompt here`) and an optional options object (e.g., `{ quiet: true }`). *Check `apiClient.js` for existing usage examples.*
* **Regular Expressions:** The user provides a regex string. Use `new RegExp(regexString, flags)` or the helper `regexFromString` (if available/imported from `../../../utils.js` as seen in `st-image-auto-generation`) to create a RegExp object for matching the `<pic>` tag. Remember the `g` flag for global search if multiple images might be requested (though the current plan implies one image per tracker update).
* **DOM Manipulation (jQuery):** The extension uses jQuery (`$`). Selectors like `$('#element-id')` and methods like `.show()`, `.hide()`, `.val()`, `.prop()`, `.on('change', ...)`, `.append()`, `.html()` are used extensively, especially in `index.js` and rendering modules.
* **`appendMediaToMessage` (imported from `script.js`):** Function used by `st-image-auto-generation` to add media (like an image URL) to an existing message's `extra` data and update the UI to display it within that message block. Requires the message *object* and the message's jQuery DOM *element*.
* **`updateMessageBlock` (imported from `script.js`):** Function used by `st-image-auto-generation` to redraw a specific message block in the UI, necessary if you directly modify the `.mes` content (like in replace mode). Takes the message index and the modified message object.
* **Chat Structure:** `context.chat` is an array of message objects. The last message is `context.chat[context.chat.length - 1]`. Messages have properties like `is_user` (boolean), `mes` (string content), `extra` (object for metadata, where images are stored for inline display, e.g., `extra.image_swipes`, `extra.image`).

**Refined Image Generation Prompt (for `promptBuilder.js`):**

```
[IMAGE PROMPT GENERATION PROTOCOL]

This instructs the second API call (separate mode) on generating an SD prompt. Prompts mix natural language and tags.

[RULE 1: CHARACTER SYNTHESIS]

Use the character's physical description verbatim: [custom physical description must be inserted here]. This ensures consistency.

Append character-specific LoRAs verbatim at the prompt's end, ignoring duplicates already present.

[RULE 2: SCENE & BIAS CONTROL]

Use RPG Companion's tracked Info Box (Date, Weather, Temp, Time, Location) and Present Characters (Name, State, Demeanor) data to describe the environment with specific details.

Generate prompts using natural language and tag weighting (e.g., (word:1.2)). NO conversational text, meta-commentary, or complex sentences. The prompt is a command.

Identify potential model biases (e.g., 'ahegao + looking at viewer' often implies kneeling). Add weighted counter-tags (e.g., (standing:1.3)) to enforce desired actions/poses.

Describe the PATH, not the GOAL, especially for bias-prone concepts. E.g., for inner sideboob with an open jacket, use (unzipped jacket:1.2), (midriff:1.1) instead of (sideboob:1.2).

ALWAYS describe the character's position (standing, sitting, lying down) and details (e.g., ((sitting:1.2)) on a couch, (legs crossed:1.1)).

[RULE 3: DETAILS REINFORCEMENT]

Ground essential clothing items with weights if their presence/integrity is key (e.g., (thin_white_tank_top:1.2) ON and covering).

Do NOT explicitly prompt implicit details unless crucial; let the model infer from descriptions. If needed, weight lower than the primary item.

AVOID overly specific/long details models won't understand (e.g., (one bikini top tie is loose:1.1)).

ALWAYS specify perspective/pose. Emphasize full body with (full body shot:1.2) or by adding details like shoes/tattoos. Emphasize portraits by omitting details outside the frame (trick by omission).

[RULE 4: HIERARCHY OF WEIGHT]

Tier 1 (Highest): Character Identity ({{char}} name/tags), Core Pose, Key Clothing (e.g., (standing:1.3), (Aimi:1.2), (white tank top:1.2)).

Tier 2 (Medium): Environment (from Info Box), Lighting, Mood (e.g., (dimly lit arcade:1.1)).

Tier 3 (Lowest): Suggestive Details, Bodily Reactions (accents only, e.g., (glistening skin:1.05)).

[RULE 5: "IMPLIED, NOT EXPLICIT" RULE]

Instead of (subtle abs from tight shirt:1.1), describe the shirt: tiny fitted shirt.

Instead of (hard nipples faintly visible:1.2), describe the fabric: thin damp tank top clinging.

[RULE 6: SYNTAX INTEGRITY]

CRITICAL: MUST use the exact format <pic prompt="[FINAL PROMPT GOES HERE]">. No ![]() or other formats.

[RULE 7: WHEN AND WHERE]

CRITICAL: Insert the <pic> tag inline at the VERY END of the tracker update block generated by this separate API call.

[PROMPT STRUCTURE]

Perspective: ({{type}}, looking at viewer, {{user gender}} pov) - Use rules from [CUSTOM USER PROMPT RULES] if provided.

Subject: Verbatim Physical Description (Rule 1) + Pose/Action (Rule 2 & 3).

Scene: Detailed environment using Info Box data (Rule 2).

Composition & Suffix: Shot type, details (e.g., close-up shot, depth of field, photorealistic details,).

LoRAs: Append character/custom LoRAs (Rule 1 / Custom Rules).

[FINAL PROMPT EXAMPLE - Incorporating Tracked Data]

<pic prompt="1girl, looking at viewer, [Verbatim Physical Description], She's ((sitting:1.2)) on a wooden tavern stool, (legs crossed:1.1), full body shot, wearing [Key Clothing Items], dimly lit tavern, wooden beams overhead, faint smell of ale, nighttime, <lora:CharacterLora:0.8>, [Custom LoRAs]">

CRITICAL: The final image tag MUST be inserted inline at the end of your generated tracker block as: <pic prompt="[FINAL PROMPT GOES HERE]">
```

**Final Steps:** Implement the changes, re-read the code and do your due dilligence, commit the changes to a branch so that the user can test in their local SillyTavern instance, document changes in `changes.md`, and perform final checks for `due_diligence.md`.

**Due Diligence:** The rules below are to be re-read and followed at every request:
1. Any existing code in the rpg-companion-sillytavern extension is verbatim unless something needs to be changed to accomodade the feature. The code works as is, any alteration might cause problems. As such, there's no need to alter anything that doesn't need to.

2. Anything that must be altered, must preserve any functions/wording originally as much as possible.

3. Any alterations must be documented within a markdown log with proper explanation of why it was done.

4. Before delivering any results, a due dilligence must be done. The repository and diffs must be re-read, alongside the agents.md, any other markdown create during the creation of the feature and correlated with what was asked. Any omission or incongruency must be logged and explained within a proper due_dilligence.md with timestamps